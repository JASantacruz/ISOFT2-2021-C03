<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DTOReserva.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Dominio_it1</a> &gt; <a href="index.source.html" class="el_package">Dominio</a> &gt; <span class="el_source">DTOReserva.java</span></div><h1>DTOReserva.java</h1><pre class="source lang-java linenums">package Dominio;

import java.sql.Date;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Time;
import java.sql.Timestamp;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.LocalTime;
import java.time.ZoneId;
import java.time.format.DateTimeFormatter;
import java.util.LinkedList;
import java.util.Locale;
import java.util.Timer;
import java.util.TimerTask;

import Persistencia.Agente;


@SuppressWarnings(&quot;static-access&quot;)
<span class="fc" id="L22">public class DTOReserva implements Turnos{</span>

<span class="fc" id="L24">	public static Agente agente = new Agente();</span>
<span class="fc" id="L25">	private static DateTimeFormatter df2 = DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd'T'HH:mm&quot;).localizedBy(new Locale(&quot;es-ES&quot;));</span>
<span class="fc" id="L26">	private static ZoneId z= ZoneId.of(&quot;Europe/London&quot;);</span>

	/**
	 * Lee las reservas que estan reservadas (en la tabla Reserva y MesaCamareroReserva) y cuya mesa tiene estado Reservada
	 * en el turno actual
	 * @param lista
	 */
	public static void leerReservas(LinkedList&lt;Integer&gt; lista) {
<span class="fc" id="L34">		LocalDateTime turnoActual= obtenerTurno();</span>

<span class="fc" id="L36">		String consultaMesasTurnoActual=&quot;(SELECT idMesa FROM MesaCamareroReserva WHERE turno='&quot;+turnoActual+&quot;')&quot;;</span>
<span class="fc" id="L37">		String consultaMesasReservadasActuales=&quot;(SELECT idMesa FROM Mesa WHERE estado='reservada' AND idMesa IN &quot;+consultaMesasTurnoActual+&quot;)&quot;;</span>
<span class="fc" id="L38">		String consultaReservasMesaReservada=&quot;SELECT idReserva FROM MesaCamareroReserva &quot;</span>
				+ &quot;WHERE turno='&quot;+turnoActual+&quot;' AND idMesa IN &quot;+consultaMesasReservadasActuales;
		try {
<span class="fc" id="L41">			ResultSet rs=agente.Read(consultaReservasMesaReservada);</span>
<span class="fc bfc" id="L42" title="All 2 branches covered.">			while(rs.next()){</span>
<span class="fc" id="L43">				lista.add(rs.getInt(1));</span>
			}
<span class="nc" id="L45">		} catch (SQLException e) {</span>
<span class="nc" id="L46">			e.printStackTrace();</span>
<span class="fc" id="L47">		}</span>
<span class="fc" id="L48">	}</span>

	public static void leerTodasReservas(LinkedList&lt;Integer&gt; lista) {
<span class="fc" id="L51">		LocalDateTime turnoActual= obtenerTurno();</span>
		//reservas distintas del turno actual
<span class="fc" id="L53">		String consulta=&quot;(SELECT idReserva FROM MesaCamareroReserva WHERE turno&lt;&gt;'&quot;+turnoActual+&quot;')&quot;;</span>
		try {
<span class="fc" id="L55">			ResultSet resultReservas=agente.Read(consulta);</span>
<span class="fc bfc" id="L56" title="All 2 branches covered.">			while(resultReservas.next()) {</span>
<span class="fc" id="L57">				lista.add(resultReservas.getInt(1));</span>
			}
<span class="nc" id="L59">		} catch (SQLException e) {</span>
<span class="nc" id="L60">			e.printStackTrace();</span>
<span class="fc" id="L61">		}</span>
		//reservas con mesa reservada del turno actual
<span class="fc" id="L63">		String consultaMesasTurnoActual=&quot;(SELECT idMesa FROM MesaCamareroReserva WHERE turno='&quot;+turnoActual+&quot;')&quot;;</span>
<span class="fc" id="L64">		String consultaMesasReservadasActuales=&quot;(SELECT idMesa FROM Mesa WHERE estado='reservada' AND idMesa IN &quot;+consultaMesasTurnoActual+&quot;)&quot;;</span>
<span class="fc" id="L65">		String consultaReservasMesaReservada=&quot;(SELECT idReserva FROM MesaCamareroReserva WHERE turno='&quot;+turnoActual+&quot;' AND idMesa IN &quot;+consultaMesasReservadasActuales+&quot;)&quot;;</span>
		try {
<span class="fc" id="L67">			ResultSet rs=agente.Read(consultaReservasMesaReservada);</span>

<span class="pc bpc" id="L69" title="1 of 2 branches missed.">			while(rs.next()){</span>
<span class="nc" id="L70">				lista.add(rs.getInt(1));</span>
			}
<span class="nc" id="L72">		} catch (SQLException e) {</span>
<span class="nc" id="L73">			e.printStackTrace();</span>
<span class="fc" id="L74">		}</span>
<span class="fc" id="L75">	}</span>
	public static int anadirReserva(String comensales, LocalDateTime fecha, String nombre, String idMesa) {
<span class="fc" id="L77">		int res=0;</span>
		ResultSet resultIdReserva;
		int idReserva;
		try {
<span class="fc" id="L81">			res=agente.Insert(&quot;INSERT INTO Reserva (idReserva,num_comensales, nombre, &quot;</span>
					+ &quot;tiempoReservada, restaurante) VALUES &quot;
					+ &quot;(null,&quot;+comensales+&quot;,'&quot;+nombre+&quot;', '&quot;+fecha+&quot;', 1)&quot;);
<span class="fc" id="L84">			resultIdReserva=agente.Read(&quot;SELECT idReserva FROM Reserva &quot;</span>
					+ &quot;WHERE num_comensales=&quot;+comensales+&quot; AND nombre='&quot;+nombre+&quot;' &quot;
							+ &quot;AND tiempoReservada='&quot;+fecha+&quot;'&quot;);
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">			if(resultIdReserva.next()){</span>
<span class="fc" id="L88">				idReserva=resultIdReserva.getInt(1);</span>
<span class="fc" id="L89">				int res2=agente.Insert(&quot;INSERT INTO MesaCamareroReserva (idReserva, idMesa, &quot;</span>
						+ &quot;turno, idCamarero) VALUES (&quot;+idReserva+&quot;, &quot;+idMesa+&quot;, '&quot;+fecha+&quot;', null)&quot;);
			}
<span class="nc" id="L92">		} catch (SQLException e) {</span>
<span class="nc" id="L93">			e.printStackTrace();</span>
<span class="fc" id="L94">		}</span>
<span class="fc" id="L95">		return res;</span>
	}

	public static int borrarReserva(String id) {
<span class="nc" id="L99">		int result=0;</span>
<span class="nc" id="L100">		LocalDateTime turnoActual=obtenerTurno();</span>
		LocalDateTime turno;
<span class="nc" id="L102">		String consultaTurno=&quot;SELECT turno FROM MesaCamareroReserva WHERE idReserva=&quot;+id;</span>

		try {
<span class="nc" id="L105">			ResultSet rsTurno=agente.Read(consultaTurno);</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">			if(rsTurno.next()) {</span>
<span class="nc" id="L107">				turno=rsTurno.getTimestamp(1).toLocalDateTime();</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">				if(turno.equals(turnoActual)) {</span>
<span class="nc" id="L109">					String consultaMesaCancelar=&quot;(SELECT idMesa FROM MesaCamareroReserva WHERE idReserva=&quot;+id+&quot;)&quot;;</span>
<span class="nc" id="L110">					String con=&quot;UPDATE Mesa SET (estado) VALUES ('libre') WHERE idMesa=&quot;+consultaMesaCancelar;</span>
<span class="nc" id="L111">					agente.Update(con);</span>
				}
<span class="nc" id="L113">				agente.Delete(&quot;DELETE FROM Reserva WHERE idReserva = &quot;+id+&quot;&quot;);</span>
			}
<span class="nc" id="L115">		} catch (SQLException e) {</span>
<span class="nc" id="L116">			e.printStackTrace();</span>
<span class="nc" id="L117">		}</span>
<span class="nc" id="L118">		return result;</span>
	}
	public static void leerReservasAux(int id, LocalDateTime turno, LinkedList&lt;Integer&gt; listaAux) {
<span class="fc" id="L121">		ResultSet rs=agente.Read(&quot;SELECT idReserva FROM MesaCamareroReserva WHERE idMesa = &quot;+id+&quot; AND turno = '&quot;+turno+&quot;'&quot;);</span>
		try {
<span class="fc bfc" id="L123" title="All 2 branches covered.">			while(rs.next()){</span>

				//Reserva reserva = new Reserva(rs.getInt(1), rs.getInt(2), rs.getString(3), rs.getTimestamp(4), rs.getInt(5), rs.getString(6), rs.getString(7));
<span class="fc" id="L126">				listaAux.add(rs.getInt(1));</span>
			}
<span class="nc" id="L128">		} catch (SQLException e) {</span>
<span class="nc" id="L129">			e.printStackTrace();</span>
<span class="fc" id="L130">		}</span>
<span class="fc" id="L131">	}</span>

	public static int cambiarTiempoEstado(String mesa, String estado) {
<span class="fc" id="L134">		String consulta=&quot;&quot;;</span>
<span class="fc" id="L135">		String subConsulta=&quot;&quot;;</span>
<span class="fc" id="L136">		LocalDateTime turno=obtenerTurno();</span>
<span class="fc" id="L137">		String tiempoActual=LocalDateTime.now().format(df2);</span>
		ResultSet rs;
<span class="fc" id="L139">		int idReserva=0;</span>
<span class="pc bpc" id="L140" title="7 of 8 branches missed.">		switch(estado) {</span>
		case &quot;ocupada&quot;:
<span class="nc" id="L142">			idReserva=obtenerIdResesrvaPorMesaTurno(mesa, turno);</span>
<span class="nc" id="L143">			consulta=&quot;UPDATE Reserva SET tiempoOcupada = '&quot;+tiempoActual+&quot;' WHERE &quot;</span>
					+ &quot;idReserva=&quot;+idReserva;
<span class="nc" id="L145">			break;</span>
		case &quot;pidiendo&quot;:
<span class="fc" id="L147">			idReserva=obtenerIdResesrvaPorMesaTurno(mesa, turno);</span>
<span class="fc" id="L148">			consulta=&quot;UPDATE Reserva SET tiempoPidiendo = '&quot;+tiempoActual+&quot;' WHERE &quot;</span>
					+ &quot;idReserva=&quot;+idReserva;
<span class="fc" id="L150">			break;</span>
		case &quot;en espera de comida&quot;:
<span class="nc" id="L152">			idReserva=obtenerIdResesrvaPorMesaTurno(mesa, turno);</span>
<span class="nc" id="L153">			consulta=&quot;UPDATE Reserva SET tiempoEnEsperaComida = '&quot;+tiempoActual+&quot;' WHERE &quot;</span>
					+ &quot;idReserva=&quot;+idReserva;
<span class="nc" id="L155">			break;</span>
		case &quot;servidos&quot;:
<span class="nc" id="L157">			idReserva=obtenerIdResesrvaPorMesaTurno(mesa, turno);</span>
<span class="nc" id="L158">			consulta=&quot;UPDATE Reserva SET tiempoServido = '&quot;+tiempoActual+&quot;' WHERE &quot;</span>
					+ &quot;idReserva=&quot;+idReserva;
<span class="nc" id="L160">			break;</span>
		case &quot;esperando la cuenta&quot;:
<span class="nc" id="L162">			idReserva=obtenerIdResesrvaPorMesaTurno(mesa, turno);</span>
<span class="nc" id="L163">			consulta=&quot;UPDATE Reserva SET tiempoEsperandoCuenta = '&quot;+tiempoActual+&quot;' WHERE &quot;</span>
					+ &quot;idReserva=&quot;+idReserva;
<span class="nc" id="L165">			break;</span>
		case &quot;pagando&quot;:
<span class="nc" id="L167">			idReserva=obtenerIdResesrvaPorMesaTurno(mesa, turno);</span>
<span class="nc" id="L168">			consulta=&quot;UPDATE Reserva SET tiempoPagando = '&quot;+tiempoActual+&quot;' WHERE &quot;</span>
					+ &quot;idReserva=&quot;+idReserva;
<span class="nc" id="L170">			break;</span>
		case &quot;en preparacion&quot;:
<span class="nc" id="L172">			idReserva=obtenerIdResesrvaPorMesaTurno(mesa, turno);</span>
<span class="nc" id="L173">			consulta=&quot;UPDATE Reserva SET tiempoEnPreparacion = '&quot;+tiempoActual+&quot;' WHERE &quot;</span>
					+ &quot;idReserva=&quot;+idReserva;
			break;
		}
<span class="fc" id="L177">		return agente.Update(consulta);</span>
	}
	public static int obtenerIdResesrvaPorMesaTurno(String idMesa, LocalDateTime turno) {
<span class="fc" id="L180">		int idReserva=-1;</span>
<span class="fc" id="L181">		String consulta=&quot;(SELECT idReserva FROM MesaCamareroReserva WHERE idMesa=&quot;+idMesa+ &quot; AND turno='&quot;+turno+&quot;')&quot;;</span>
		try {
<span class="fc" id="L183">			ResultSet rs=agente.Read(consulta);</span>
<span class="pc bpc" id="L184" title="1 of 2 branches missed.">			if(rs.next())</span>
<span class="fc" id="L185">				idReserva=rs.getInt(1);</span>
<span class="nc" id="L186">		} catch (SQLException e) {</span>
<span class="nc" id="L187">			e.printStackTrace();</span>
<span class="fc" id="L188">		}</span>
<span class="fc" id="L189">		return idReserva;</span>
	}
	public static LocalDateTime obtenerTurno() {
<span class="fc" id="L192">		DateTimeFormatter df2 = DateTimeFormatter.ofPattern(&quot;HH:mm&quot;).localizedBy(new Locale(&quot;es-ES&quot;));</span>
<span class="fc" id="L193">		LocalDateTime turno=null;</span>
<span class="fc" id="L194">		LocalDate fechaActual =LocalDate.now(ZoneId.systemDefault());</span>
<span class="fc" id="L195">		LocalTime horaPrueba=LocalTime.parse(&quot;13:30&quot;, df2);</span>
<span class="fc" id="L196">		LocalDateTime turno1Comida = LocalDateTime.of(fechaActual, Turno1Comida);</span>
<span class="fc" id="L197">		LocalDateTime turno2Comida = LocalDateTime.of(fechaActual, Turno2Comida);</span>
<span class="fc" id="L198">		LocalDateTime turno3Comida = LocalDateTime.of(fechaActual, Turno3Comida);</span>
<span class="fc" id="L199">		LocalDateTime turno1Cena = LocalDateTime.of(fechaActual, Turno1Cena);</span>
<span class="fc" id="L200">		LocalDateTime turno2Cena = LocalDateTime.of(fechaActual, Turno2Cena);</span>
<span class="fc" id="L201">		LocalDateTime turno3Cena = LocalDateTime.of(fechaActual, Turno3Cena);</span>
<span class="fc" id="L202">		LocalDateTime turnoLimite = LocalDateTime.of(fechaActual, limiteTurno);</span>
		//LocalDateTime tiempoActual = LocalDateTime.now();
<span class="fc" id="L204">		LocalDateTime tiempoActual = LocalDateTime.of(fechaActual, horaPrueba);</span>

<span class="pc bpc" id="L206" title="2 of 4 branches missed.">		if(tiempoActual.isAfter(turno1Comida) &amp;&amp; tiempoActual.isBefore(turno2Comida)) {</span>
<span class="fc" id="L207">			turno=turno1Comida;</span>
<span class="nc bnc" id="L208" title="All 4 branches missed.">		}else if(tiempoActual.isAfter(turno2Comida) &amp;&amp; tiempoActual.isBefore(turno3Comida)){</span>
<span class="nc" id="L209">			turno=turno2Comida;</span>
<span class="nc bnc" id="L210" title="All 4 branches missed.">		}else if(tiempoActual.isAfter(turno3Comida) &amp;&amp; tiempoActual.isBefore(turno1Cena)) {</span>
<span class="nc" id="L211">			turno=turno3Comida;</span>
<span class="nc bnc" id="L212" title="All 4 branches missed.">		}else if(tiempoActual.isAfter(turno1Cena) &amp;&amp; tiempoActual.isBefore(turno2Cena)) {</span>
<span class="nc" id="L213">			turno=turno1Cena;</span>
<span class="nc bnc" id="L214" title="All 4 branches missed.">		}else if(tiempoActual.isAfter(turno2Cena) &amp;&amp; tiempoActual.isBefore(turno3Cena)) {</span>
<span class="nc" id="L215">			turno=turno2Cena;</span>
<span class="nc bnc" id="L216" title="All 4 branches missed.">		}else if(tiempoActual.isAfter(turno3Cena) &amp;&amp; tiempoActual.isBefore(turnoLimite)) {</span>
<span class="nc" id="L217">			turno=turno3Cena;</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">		}else if(tiempoActual.isBefore(turno1Comida)) {</span>
<span class="nc" id="L219">			turno=null;</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">		}else if(tiempoActual.isAfter(turnoLimite)) {</span>
<span class="nc" id="L221">			turno=null;</span>
		}
<span class="fc" id="L223">		return turno;</span>
	}

	public static void leerReserva(String id, LinkedList&lt;Reserva&gt; listaAux) {
<span class="fc" id="L227">		ResultSet rs=agente.Read(&quot;SELECT * FROM Reserva WHERE idReserva = &quot;+id+&quot;;&quot;);</span>
		try {
<span class="fc bfc" id="L229" title="All 2 branches covered.">			while(rs.next()){</span>
<span class="fc" id="L230">				Reserva reserva = new Reserva(rs.getInt(1), rs.getInt(2), rs.getString(3));</span>
<span class="fc" id="L231">				listaAux.add(reserva);</span>
<span class="fc" id="L232">			}</span>
<span class="nc" id="L233">		} catch (SQLException e) {</span>
<span class="nc" id="L234">			e.printStackTrace();</span>
<span class="fc" id="L235">		}</span>
<span class="fc" id="L236">	}</span>
	public static LocalDateTime obtenerFechaReserva(String idReserva) {
<span class="fc" id="L238">		String consulta=&quot;SELECT turno FROM MesaCamareroReserva WHERE idReserva=&quot;+idReserva;</span>
<span class="fc" id="L239">		LocalDateTime turno=null;</span>
		try {
<span class="fc" id="L241">			ResultSet resultTurno=agente.Read(consulta);</span>
<span class="pc bpc" id="L242" title="1 of 2 branches missed.">			if(resultTurno.next()) {</span>
<span class="fc" id="L243">				turno=resultTurno.getTimestamp(1).toInstant().atZone(z).toLocalDateTime();</span>
			}
<span class="nc" id="L245">		} catch (SQLException e) {</span>
<span class="nc" id="L246">			e.printStackTrace();</span>
<span class="fc" id="L247">		}</span>
<span class="fc" id="L248">		return turno;</span>
	}
	public static void comprobarClienteTardio() {
<span class="fc" id="L251">		DateTimeFormatter df2 = DateTimeFormatter.ofPattern(&quot;HH:mm&quot;).localizedBy(new Locale(&quot;es-ES&quot;));</span>
<span class="fc" id="L252">		LocalDateTime turno=null;</span>
<span class="fc" id="L253">		LocalDate fechaActual =LocalDate.now(ZoneId.systemDefault());</span>
<span class="fc" id="L254">		LocalTime horaActual=LocalTime.now();</span>
<span class="fc" id="L255">		LocalDateTime turnoActual=DTOReserva.obtenerTurno();</span>
<span class="fc" id="L256">		LocalDateTime tiempoActual = LocalDateTime.of(fechaActual, LocalTime.parse(horaActual.format(df2)));</span>
<span class="pc bpc" id="L257" title="1 of 2 branches missed.">		if(tiempoActual.isAfter(turnoActual.plusMinutes(20))) {</span>
			ResultSet resultIdMesa;
<span class="fc" id="L259">			String consultaMesasTurnoActual=&quot;(SELECT idMesa FROM MesaCamareroReserva WHERE turno='&quot;+turnoActual+&quot;')&quot;;</span>
<span class="fc" id="L260">			String consulta=&quot;SELECT idMesa FROM Mesa WHERE estado='reservada' AND idMesa IN&quot;+consultaMesasTurnoActual;</span>
			try {
<span class="fc" id="L262">				resultIdMesa=agente.Read(consulta);</span>
<span class="fc bfc" id="L263" title="All 2 branches covered.">				while(resultIdMesa.next()) {</span>
<span class="fc" id="L264">					String consultaIdReservaEliminar=&quot;(SELECT idReserva FROM MesaCamareroReserva WHERE &quot;</span>
<span class="fc" id="L265">							+ &quot;idMesa=&quot;+resultIdMesa.getInt(1)+&quot; AND turno='&quot;+turnoActual+&quot;')&quot;;</span>
<span class="fc" id="L266">					agente.Delete(&quot;DELETE FROM Reserva WHERE idReserva=&quot;+consultaIdReservaEliminar);</span>
<span class="fc" id="L267">				}</span>
<span class="nc" id="L268">			} catch (SQLException e) {</span>
<span class="nc" id="L269">				e.printStackTrace();</span>
<span class="fc" id="L270">			}</span>
		}
<span class="fc" id="L272">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>